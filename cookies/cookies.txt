import os
import shutil
import time
import tempfile
import undetected_chromedriver as uc

def save_cookies_to_netscape_file(cookies, output_file):
    with open(output_file, 'w') as f:
        f.write("# Netscape HTTP Cookie File\n")
        f.write("# This is a generated file! Do not edit.\n\n")
        f.write("# domain  include_subdomains  path  secure  expiration_date  name  value\n")
        for cookie in cookies:
            expiry = cookie.get('expiry') or 0
            f.write(f"{cookie['domain']}\t")
            f.write("TRUE\t")
            f.write(f"{cookie['path']}\t")
            f.write("TRUE\t" if cookie.get('secure') else "FALSE\t")
            f.write(f"{int(expiry)}\t")
            f.write(f"{cookie['name']}\t{cookie['value']}\n")

# Create a manual temporary directory for user data
temp_profile = tempfile.mkdtemp()
try:
    options = uc.ChromeOptions()
    options.add_argument(f"--user-data-dir={temp_profile}")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-infobars")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-blink-features=AutomationControlled")
    options.add_argument("--start-maximized")
    options.add_argument("--autoplay-policy=no-user-gesture-required")

    # Initialize undetected ChromeDriver
    driver = uc.Chrome(options=options)

    try:
        driver.get("https://www.youtube.com")
        print("Login to your YouTube account and play a video.")
        input("Press Enter once logged in and a video is playing...")

        cookies = driver.get_cookies()
        output_file = input("Enter a name for your cookies file (without extension): ") + ".txt"
        save_cookies_to_netscape_file(cookies, output_file)
        print(f"Cookies saved to: {output_file}")

    finally:
        driver.quit()
        time.sleep(2)

finally:
    # Retry cleanup for temporary profile
    for attempt in range(3):
        try:
            shutil.rmtree(temp_profile)
            print("Temporary profile cleaned up.")
            break
        except Exception as e:
            print(f"Warning: Cleanup attempt {attempt + 1} failed: {e}")
            time.sleep(1)
